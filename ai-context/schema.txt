generator client {
provider = "prisma-client-js"
}

datasource db {
provider = "postgresql"
url      = env("DATABASE_URL")
}

enum UserRole {
ADMIN
USER
}

enum JobStatus {
QUEUED
RUNNING
COMPLETED
FAILED
CANCELED
}

enum AnalysisResult {
PASS
FAIL
WARNING
}

enum IssueType {
BLACK_FRAME
FREEZE_FRAME
SILENCE
FORMAT_MISMATCH
LOUDNESS
SHORT_SHOT
BLURRY_FRAME
GAMUT
DEAD_PIXEL
METADATA
OTHER
}

enum IssueSeverity {
INFO
WARNING
ERROR
}

enum StorageProvider {
S3
BUNNY
WASABI
OTHER
}

enum VideoSourceType {
DIRECT_UPLOAD
API
INTEGRATION
}

enum ReportFormat {
HTML
PDF
JSON
}

enum SubscriptionStatus {
INCOMPLETE
INCOMPLETE_EXPIRED
TRIALING
ACTIVE
PAST_DUE
CANCELED
UNPAID
}

enum NotificationType {
ANALYSIS_COMPLETED
ANALYSIS_FAILED
BILLING_REMINDER
SYSTEM
}

enum NotificationChannel {
EMAIL
IN_APP
WEBHOOK
}

enum AuditEventType {
USER_LOGIN
USER_LOGOUT
USER_REGISTERED
USER_UPDATED
VIDEO_UPLOADED
VIDEO_DELETED
ANALYSIS_CREATED
ANALYSIS_STATUS_CHANGED
SUBSCRIPTION_UPDATED
BILLING_EVENT
OTHER
}

enum WebhookStatus {
ACTIVE
DISABLED
}

model User {
id                    String                   @id @default(cuid())
name                  String?
email                 String?                  @unique
emailVerified         DateTime?                @map("email_verified")
image                 String?
password              String?
isTwoFactorEnabled    Boolean                  @default(false)
role                  UserRole                 @default(USER)
failedLoginAttempts   Int                      @default(0) @map("failed_login_attempts")
lockedUntil           DateTime?                @map("locked_until")
accounts              Account[]
TwoFactorConfirmation TwoFactorConfirmation?

companyName           String?                  @map("company_name")
country               String?
createdAt             DateTime                 @default(now()) @map("created_at")
lastLoginAt           DateTime?                @map("last_login_at")
planId                String?                  @map("plan_id")
isAdmin               Boolean                  @default(false) @map("is_admin")

subscriptionPlan      SubscriptionPlan?        @relation(fields: [planId], references: [id], onDelete: SetNull)
videoAssets           VideoAsset[]
analysisJobs          AnalysisJob[]
subscriptions         Subscription[]
usageRecords          UsageRecord[]
notifications         Notification[]
notificationPreference NotificationPreference?
auditLogs             AuditLog[]
webhookEndpoints      WebhookEndpoint[]

@@index([planId])
@@map("users")
}

model Account {
id                String  @id @default(cuid())
userId            String  @map("user_id")
type              String
provider          String
providerAccountId String  @map("provider_account_id")
refresh_token     String? @db.Text
access_token      String? @db.Text
expires_at        Int?
token_type        String?
scope             String?
id_token          String? @db.Text
session_state     String?

user User @relation(fields: [userId], references: [id], onDelete: Cascade)

@@unique([provider, providerAccountId])
@@map("accounts")
}

model VerificationToken {
id      String   @id @default(cuid())
email   String
token   String   @unique
expires DateTime

@@unique([email, token])
@@map("verification_token")
}

model PasswordResetToken {
id      String   @id @default(cuid())
email   String
token   String   @unique
expires DateTime

@@unique([email, token])
@@map("password_reset_token")
}

model TwoFactorToken {
id      String   @id @default(cuid())
email   String
token   String   @unique
expires DateTime

@@unique([email, token])
@@map("two_factor_token")
}

model TwoFactorConfirmation {
id     String @id @default(cuid())
userId String

user User @relation(fields: [userId], references: [id], onDelete: Cascade)

@@unique([userId])
@@map("two_factor_confimation")
}

model VideoAsset {
id               String          @id @default(cuid())
userId           String          @map("user_id")
originalFileName String          @map("original_file_name")
storagePath      String          @map("storage_path")
storageProvider  StorageProvider @default(S3) @map("storage_provider")
storageBucket    String?         @map("storage_bucket")
durationSeconds  Int?            @map("duration_seconds")
resolutionWidth  Int?            @map("resolution_width")
resolutionHeight Int?            @map("resolution_height")
frameRate        Float?          @map("frame_rate")
fileSizeBytes    BigInt?         @map("file_size_bytes")
videoCodec       String?         @map("video_codec")
audioCodec       String?         @map("audio_codec")
checksum         String?         @map("checksum")
sourceType       VideoSourceType @default(DIRECT_UPLOAD) @map("source_type")
uploadedAt       DateTime        @default(now()) @map("uploaded_at")
deletedAt        DateTime?       @map("deleted_at")

user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
analysisJobs AnalysisJob[]

@@unique([userId, checksum])
@@index([userId, uploadedAt])
@@map("video_assets")
}

model QCPreset {
id                            String      @id @default(cuid())
name                          String
slug                          String      @unique
description                   String?     @db.Text
isDefault                     Boolean     @default(false) @map("is_default")
targetResolution              String?     @map("target_resolution")
targetFrameRate               Float?      @map("target_frame_rate")
targetAspectRatio             String?     @map("target_aspect_ratio")
loudnessTargetLufs            Float?      @map("loudness_target_lufs")
maxPeakDb                     Float?      @map("max_peak_db")
blackFrameThresholdSeconds    Float?      @map("black_frame_threshold_seconds")
freezeFrameThresholdSeconds   Float?      @map("freeze_frame_threshold_seconds")
silenceThresholdDb            Float?      @map("silence_threshold_db")
silenceMinDurationSeconds     Float?      @map("silence_min_duration_seconds")
shortShotThresholdFrames      Int?        @map("short_shot_threshold_frames")
createdAt                     DateTime    @default(now()) @map("created_at")
updatedAt                     DateTime    @default(now()) @updatedAt @map("updated_at")

analysisJobs AnalysisJob[]

@@map("qc_presets")
}

model AnalysisJob {
id                      String          @id @default(cuid())
userId                  String          @map("user_id")
videoAssetId            String          @map("video_asset_id")
qcPresetId              String?         @map("qc_preset_id")
externalJobId           String?         @unique @map("external_job_id")
status                  JobStatus       @default(QUEUED)
overallResult           AnalysisResult? @map("overall_result")
presetName              String?         @map("preset_name")
queueName               String?         @map("queue_name")
priority                Int             @default(0)
errorMessage            String?         @db.Text @map("error_message")
integratedLoudnessLufs  Float?          @map("integrated_loudness_lufs")
maxPeakDb               Float?          @map("max_peak_db")
blackFrameCount         Int             @default(0) @map("black_frame_count")
freezeFrameCount        Int             @default(0) @map("freeze_frame_count")
silentSegmentCount      Int             @default(0) @map("silent_segment_count")
shortShotCount          Int             @default(0) @map("short_shot_count")
durationSecondsAnalyzed Int?            @map("duration_seconds_analyzed")
rawMetricsJson          Json?           @map("raw_metrics_json")
metadataJson            Json?           @map("metadata_json")
billingSeconds          Int?            @map("billing_seconds")
startedAt               DateTime?       @map("started_at")
finishedAt              DateTime?       @map("finished_at")
createdAt               DateTime        @default(now()) @map("created_at")
updatedAt               DateTime        @default(now()) @updatedAt @map("updated_at")

user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
videoAsset  VideoAsset  @relation(fields: [videoAssetId], references: [id], onDelete: Cascade)
qcPreset    QCPreset?   @relation(fields: [qcPresetId], references: [id], onDelete: SetNull)
issues      Issue[]
reports     AnalysisReport[]
notifications Notification[]

@@index([userId, createdAt])
@@index([videoAssetId])
@@index([status, createdAt])
@@map("analysis_jobs")
}

model Issue {
id            String        @id @default(cuid())
analysisJobId String        @map("analysis_job_id")
type          IssueType
severity      IssueSeverity @default(ERROR)
code          String?       @map("code")
message       String        @db.Text @map("message")
timecodeIn    String?       @map("timecode_in")
timecodeOut   String?       @map("timecode_out")
secondsIn     Float?        @map("seconds_in")
secondsOut    Float?        @map("seconds_out")
extraDataJson Json?         @map("extra_data_json")
createdAt     DateTime      @default(now()) @map("created_at")

analysisJob AnalysisJob @relation(fields: [analysisJobId], references: [id], onDelete: Cascade)

@@index([analysisJobId])
@@index([type, severity])
@@map("issues")
}

model AnalysisReport {
id              String          @id @default(cuid())
analysisJobId   String          @map("analysis_job_id")
format          ReportFormat    @map("format")
storagePath     String          @map("storage_path")
storageProvider StorageProvider @default(S3) @map("storage_provider")
fileSizeBytes   BigInt?         @map("file_size_bytes")
generatedAt     DateTime        @default(now()) @map("generated_at")
expiresAt       DateTime?       @map("expires_at")

analysisJob AnalysisJob @relation(fields: [analysisJobId], references: [id], onDelete: Cascade)

@@index([analysisJobId])
@@map("analysis_reports")
}

model SubscriptionPlan {
id                 String         @id @default(cuid())
name               String
slug               String         @unique
description        String?        @db.Text
monthlyPriceCents  Int            @map("monthly_price_cents")
currency           String         @default("czk")
maxMinutesPerMonth Int?           @map("max_minutes_per_month")
maxVideosPerMonth  Int?           @map("max_videos_per_month")
maxConcurrentJobs  Int?           @map("max_concurrent_jobs")
maxUsers           Int?           @map("max_users")
sortOrder          Int            @default(0) @map("sort_order")
isActive           Boolean        @default(true) @map("is_active")
createdAt          DateTime       @default(now()) @map("created_at")
updatedAt          DateTime       @default(now()) @updatedAt @map("updated_at")

subscriptions Subscription[]
users         User[]

@@map("subscription_plans")
}

model Subscription {
id                   String             @id @default(cuid())
userId               String             @map("user_id")
subscriptionPlanId   String             @map("subscription_plan_id")
status               SubscriptionStatus @default(INCOMPLETE)
stripeCustomerId     String?            @map("stripe_customer_id")
stripeSubscriptionId String?            @unique @map("stripe_subscription_id")
currentPeriodStart   DateTime?          @map("current_period_start")
currentPeriodEnd     DateTime?          @map("current_period_end")
cancelAtPeriodEnd    Boolean            @default(false) @map("cancel_at_period_end")
canceledAt           DateTime?          @map("canceled_at")
trialEndsAt          DateTime?          @map("trial_ends_at")
createdAt            DateTime           @default(now()) @map("created_at")
updatedAt            DateTime           @default(now()) @updatedAt @map("updated_at")

user             User             @relation(fields: [userId], references: [id], onDelete: Cascade)
subscriptionPlan SubscriptionPlan @relation(fields: [subscriptionPlanId], references: [id])
usageRecords     UsageRecord[]

@@index([userId, status])
@@index([subscriptionPlanId])
@@index([stripeCustomerId])
@@map("subscriptions")
}

model UsageRecord {
id                  String        @id @default(cuid())
userId              String        @map("user_id")
subscriptionId      String?       @map("subscription_id")
periodStart         DateTime      @map("period_start")
periodEnd           DateTime      @map("period_end")
minutesUsed         Int           @default(0) @map("minutes_used")
videosUsed          Int           @default(0) @map("videos_used")
storageBytesUsed    BigInt        @default(0) @map("storage_bytes_used")
analysisSecondsUsed Int           @default(0) @map("analysis_seconds_used")
createdAt           DateTime      @default(now()) @map("created_at")
updatedAt           DateTime      @default(now()) @updatedAt @map("updated_at")

user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
subscription Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)

@@unique([userId, periodStart, periodEnd])
@@index([subscriptionId])
@@map("usage_records")
}

model Notification {
id            String             @id @default(cuid())
userId        String             @map("user_id")
analysisJobId String?            @map("analysis_job_id")
type          NotificationType   @map("type")
channel       NotificationChannel @map("channel")
subject       String
body          String?            @db.Text
metadataJson  Json?              @map("metadata_json")
readAt        DateTime?          @map("read_at")
createdAt     DateTime           @default(now()) @map("created_at")

user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
analysisJob AnalysisJob? @relation(fields: [analysisJobId], references: [id], onDelete: SetNull)

@@index([userId, createdAt])
@@index([analysisJobId])
@@map("notifications")
}

model NotificationPreference {
id           String   @id @default(cuid())
userId       String   @unique @map("user_id")
emailEnabled Boolean  @default(true) @map("email_enabled")
inAppEnabled Boolean  @default(true) @map("in_app_enabled")
createdAt    DateTime @default(now()) @map("created_at")
updatedAt    DateTime @default(now()) @updatedAt @map("updated_at")

user User @relation(fields: [userId], references: [id], onDelete: Cascade)

@@map("notification_preferences")
}

model AuditLog {
id           String         @id @default(cuid())
userId       String?        @map("user_id")
eventType    AuditEventType @map("event_type")
ipAddress    String?        @map("ip_address")
userAgent    String?        @map("user_agent")
metadataJson Json?          @map("metadata_json")
createdAt    DateTime       @default(now()) @map("created_at")

user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

@@index([userId, createdAt])
@@map("audit_logs")
}

model WebhookEndpoint {
id         String        @id @default(cuid())
userId     String        @map("user_id")
url        String
secret     String
status     WebhookStatus @default(ACTIVE)
eventTypes String[]      @map("event_types")
createdAt  DateTime      @default(now()) @map("created_at")
updatedAt  DateTime      @default(now()) @updatedAt @map("updated_at")
lastUsedAt DateTime?     @map("last_used_at")

user User @relation(fields: [userId], references: [id], onDelete: Cascade)

@@index([userId])
@@map("webhook_endpoints")
}
